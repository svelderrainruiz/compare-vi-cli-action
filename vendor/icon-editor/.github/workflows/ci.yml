# .github/workflows/ci.yml
name: CI Pipeline (Open-Source Actions)

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
      - develop
      - release-alpha/*
      - release-beta/*
      - release-rc/*
      - feature/*
      - hotfix/*
      - issue-*
  pull_request:
    branches:
      - main
      - develop
      - release-alpha/*
      - release-beta/*
      - release-rc/*
      - feature/*
      - hotfix/*
      - issue-*
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch: {}  # allow manual trigger

jobs:
  issue-status:
    name: Verify Issue Status
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      # GitHub Script to check if branch name links to an "In Progress" issue
      - name: Determine if CI should run
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.payload.pull_request?.head.ref 
                         ?? context.ref.replace('refs/heads/', '');
            const match = branch.match(/(?:^|\/)issue-(\d+)/);
            if (!match) {
              core.setOutput('proceed', 'false');
              core.info(`Branch '${branch}' is not issue-specific. CI will be skipped.`);
              return;
            }
            const issueNumber = Number(match[1]);
            // Check for "NoCI" label on PR or branch
            let hasNoCI = false;
            if (context.payload.pull_request) {
              hasNoCI = context.payload.pull_request.labels.some(l => l.name === 'NoCI');
            } else {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'open'
              });
              hasNoCI = prs.some(pr => pr.labels.some(l => l.name === 'NoCI'));
            }
            if (hasNoCI) {
              core.setOutput('proceed', 'false');
              core.info(`Branch '${branch}' has 'NoCI' label. CI will be skipped.`);
              return;
            }
            // Query issue status from project (GraphQL)
            const query = `query($owner:String!,$repo:String!,$number:Int!){
              repository(owner:$owner,name:$repo){
                issue(number:$number){
                  projectItems(first:10){ nodes{
                    fieldValueByName(name:"Status"){ ... on ProjectV2ItemFieldSingleSelectValue{ name } }
                  } }
                }
              }
            }`;
            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issueNumber
            };
            let result;
            try {
              result = await github.graphql(query, variables);
            } catch (error) {
              core.error(`GraphQL query failed: ${error.message}`);
            }
            const nodes = result?.repository?.issue?.projectItems?.nodes ?? [];
            const statusName = nodes.map(n => n.fieldValueByName?.name).find(Boolean) ?? 'Unknown';
            const proceed = (statusName === 'In Progress');
            core.info(`Issue #${issueNumber} status: ${statusName} -> CI ${proceed ? 'will run' : 'skipped'}`);
            core.setOutput('proceed', proceed ? 'true' : 'false');
  
  changes:
    name: Detect VIPC Changes
    needs: issue-status
    if: needs.issue-status.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    outputs:
      vipc: ${{ steps.filter.outputs.vipc }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            vipc:
              - '**/*.vipc'

  apply-deps:
    name: Apply VIPC Dependencies
    needs: changes
    if: needs.changes.outputs.vipc == 'true'
    runs-on: self-hosted-windows-lv
    strategy:
      matrix:
        include:
          - lv: "2021"   # LabVIEW 2021 32-bit
            bits: "32"
          - lv: "2021"   # LabVIEW 2021 64-bit
            bits: "64"
          - lv: "2023"   # LabVIEW 2023 64-bit (for SP1)
            bits: "64"
    steps:
      - uses: LabVIEW-Community-CI-CD/open-source-actions/apply-vipc@v1
        with:
          minimum_supported_lv_version: ${{ matrix.lv }}
          vip_lv_version:               ${{ matrix.lv }}
          supported_bitness:            ${{ matrix.bits }}
          relative_path:                ${{ github.workspace }}

  version:
    name: Compute Version
    needs: issue-status
    if: needs.issue-status.outputs.proceed == 'true'
    runs-on: self-hosted-windows-lv
    outputs:
      MAJOR:         ${{ steps.compute.outputs.MAJOR }}
      MINOR:         ${{ steps.compute.outputs.MINOR }}
      PATCH:         ${{ steps.compute.outputs.PATCH }}
      BUILD:         ${{ steps.compute.outputs.BUILD }}
      VERSION:       ${{ steps.compute.outputs.VERSION }}
      IS_PRERELEASE: ${{ steps.compute.outputs.IS_PRERELEASE }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - id: compute
        uses: LabVIEW-Community-CI-CD/open-source-actions/compute-version@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Run Unit Tests
    needs: [changes, apply-deps]   # proceed only if deps applied or not needed
    if: ${{ needs.changes.result == 'success' && (needs.apply-deps.result == 'success' || needs.apply-deps.result == 'skipped') }}
    runs-on: self-hosted-windows-lv
    strategy:
      fail-fast: false
      matrix:
        lv: ["2021"]    # Test in LabVIEW 2021
        bits: ["64", "32"]
    steps:
      - uses: LabVIEW-Community-CI-CD/open-source-actions/run-unit-tests@v1
        with:
          minimum_supported_lv_version: ${{ matrix.lv }}
          supported_bitness:            ${{ matrix.bits }}

  build-ppl:
    name: Build Packed Library (${{ matrix.bits }}-bit)
    needs: [test, version]
    runs-on: self-hosted-windows-lv
    permissions:
      contents: read
      actions: write   # allow upload-artifact
    strategy:
      matrix:
        bits: [32, 64]
        include:
          - bits: 32
            suffix: x86
          - bits: 64
            suffix: x64
    steps:
      - uses: LabVIEW-Community-CI-CD/open-source-actions/build-lvlibp@v1
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: ${{ matrix.bits }}
          relative_path:     ${{ github.workspace }}
          major: ${{ needs.version.outputs.MAJOR }}
          minor: ${{ needs.version.outputs.MINOR }}
          patch: ${{ needs.version.outputs.PATCH }}
          build: ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
      - uses: LabVIEW-Community-CI-CD/open-source-actions/close-labview@v1
        with:
          minimum_supported_lv_version: 2021
          supported_bitness: ${{ matrix.bits }}
      - uses: LabVIEW-Community-CI-CD/open-source-actions/rename-file@v1
        with:
          current_filename: ${{ github.workspace }}/resource/plugins/lv_icon.lvlibp
          new_filename:     ${{ github.workspace }}/resource/plugins/lv_icon_${{ matrix.suffix }}.lvlibp
      - uses: actions/upload-artifact@v4
        with:
          name: lv_icon_${{ matrix.suffix }}.lvlibp
          path: resource/plugins/lv_icon_${{ matrix.suffix }}.lvlibp

  build-vi-package:
    name: Build VI Package
    needs: [build-ppl, version]
    runs-on: self-hosted-windows-lv
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Generate release notes
        uses: LabVIEW-Community-CI-CD/open-source-actions/generate-release-notes@v1
        # (Generates Tooling/deployment/release_notes.md by default)
      - uses: actions/download-artifact@v4    # retrieve the built PPL files
        with:
          path: resource/plugins
          name: lv_icon_*.lvlibp
          # (download artifact names matching pattern to resource/plugins)
      - name: Generate display information JSON
        id: display-info
        shell: pwsh
        run: |
          $info = @{
            "Package Version" = @{
              "major" = ${{ needs.version.outputs.MAJOR }}
              "minor" = ${{ needs.version.outputs.MINOR }}
              "patch" = ${{ needs.version.outputs.PATCH }}
              "build" = ${{ needs.version.outputs.BUILD }}
            }
            "Product Name" = ""
            "Company Name" = "${{ github.repository_owner }}"
            "Author Name (Person or Company)" = "${{ github.event.repository.name }}"
            "Product Homepage (URL)" = ""
            "Legal Copyright" = ""
            "License Agreement Name" = ""
            "Product Description Summary" = ""
            "Product Description" = ""
            "Release Notes - Change Log" = ""
          }
          $json = $info | ConvertTo-Json -Depth 5 -Compress
          "json=$json" >> $Env:GITHUB_OUTPUT
      - uses: LabVIEW-Community-CI-CD/open-source-actions/modify-vipb-display-info@v1
        with:
          supported_bitness:        64
          relative_path:            ${{ github.workspace }}
          vipb_path:                Tooling/deployment/NI Icon editor.vipb
          minimum_supported_lv_version: 2023       # target LabVIEW 2023
          # labview_minor_revision is omitted (defaults to 3 for LabVIEW SP1)
          major:  ${{ needs.version.outputs.MAJOR }}
          minor:  ${{ needs.version.outputs.MINOR }}
          patch:  ${{ needs.version.outputs.PATCH }}
          build:  ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
          release_notes_file:       ${{ github.workspace }}/Tooling/deployment/release_notes.md
          display_information_json: ${{ steps.display-info.outputs.json }}
      - uses: LabVIEW-Community-CI-CD/open-source-actions/build-vi-package@v1
        with:
          supported_bitness:        64
          minimum_supported_lv_version: 2023
          # labview_minor_revision omitted (uses default = 3)
          major:  ${{ needs.version.outputs.MAJOR }}
          minor:  ${{ needs.version.outputs.MINOR }}
          patch:  ${{ needs.version.outputs.PATCH }}
          build:  ${{ needs.version.outputs.BUILD }}
          commit: ${{ github.sha }}
          release_notes_file:       ${{ github.workspace }}/Tooling/deployment/release_notes.md
          display_information_json: ${{ steps.display-info.outputs.json }}
      - uses: LabVIEW-Community-CI-CD/open-source-actions/close-labview@v1
        with:
          minimum_supported_lv_version: 2023
          supported_bitness: 64
      - name: Upload VI Package
        uses: actions/upload-artifact@v4
        with:
          name: vi-package
          path: builds/VI Package/*.vip
