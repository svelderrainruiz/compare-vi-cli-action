# Icon Editor VI Package Build Notes

This repository no longer tracks a prebuilt Icon Editor VIP. Every
package is produced on demand by the CI pipeline (and by the local
helpers) from the current sources.

## Building locally

The composite workflow and the helper scripts expect LabVIEW 2023
(32-bit and 64-bit) for the PPL builds and LabVIEW 2026 (64-bit) for
the VIPM CLI packaging step. To build the package on a workstation:

```powershell
# Install VIPC dependencies (preferred helper)
pwsh -File tools/icon-editor/Invoke-VipmDependencies.ps1 `
  -MinimumSupportedLVVersion 2023 `
  -VIP_LVVersion 2026 `
  -SupportedBitness 64

# Display installed packages only (no install)
pwsh -File tools/icon-editor/Invoke-VipmDependencies.ps1 `
  -MinimumSupportedLVVersion 2026 `
  -VIP_LVVersion 2026 `
  -SupportedBitness 64 `
  -DisplayOnly


# Enable the required LabVIEW development modes for packaging
pwsh -File tools/icon-editor/Enable-DevMode.ps1 `
  -RepoRoot . `
  -IconEditorRoot vendor/icon-editor `
  -Operation BuildPackage

# Run the non-LV dependency install and package build helpers as needed.
pwsh -File tools/Run-NonLVChecksInDocker.ps1
pwsh -File tools/icon-editor/Invoke-VipmCliBuild.ps1

# After the build completes, disable development mode.
pwsh -File tools/icon-editor/Disable-DevMode.ps1 `
  -RepoRoot . `
  -IconEditorRoot vendor/icon-editor `
  -Operation BuildPackage

# (Optional) Force a clean LabVIEW workspace reset.
pwsh -File tools/icon-editor/Reset-IconEditorWorkspace.ps1 `
  -RepoRoot . `
  -IconEditorRoot vendor/icon-editor `
  -Versions 2023 `
  -Bitness 32,64
```

The helpers will drop the packaged VIP under `builds/VI Package/`.
Upload the resulting VIP to artifact storage (or attach it to a release)
instead of committing it to the repository.

> **Note**  
> `Disable-DevMode.ps1` already calls the reset helper so CI and scripted builds return LabVIEW to a clean state automatically. The explicit `Reset-IconEditorWorkspace.ps1` invocation above is handy when you abort a run midway, experiment with g-cli manually, or need to clean only a subset of versions/bitness before the next build.

### VIPM CLI prerequisites

- Install the VIPM CLI and ensure it is available on `PATH` (or set `VIPM_PATH`/`VIPM_EXE_PATH`).
- Verify the tooling before running dependency installs or package builds:

  ```powershell
  vipm --version
  vipm build --help
  ```

- Confirm LabVIEW 2026 (64-bit) is installed/registered via
  `Find-LabVIEWVersionExePath`. `ApplyVIPC.ps1` now fails fast when the
  CLI or the LabVIEW beta are missing.
- Each VIPM dependency install writes telemetry under
  `tests/results/_agent/icon-editor/vipm-install/`. Review these JSON
  logs to see the exact command, arguments, and exit code for a given
  run.
- The legacy `.github/actions/apply-vipc/ApplyVIPC.ps1` wrapper now
  shells directly into `Invoke-VipmDependencies.ps1` and exists only to
  support the composite action. All new scripts should call the helper
  directly.

## CI packaging flow (overview)

- `apply-deps`: installs the required VIPCs for each LabVIEW target via
  the VIPM CLI (default). The step runs the readiness checks above and
  uploads the telemetry logs.
- `enable-dev-mode`: enables the icon-editor development mode for the
  relevant LabVIEW versions/bitness.
- `build-ppl`: builds the packed libraries for 32-bit and 64-bit LabVIEW
  2023.
- `build-vi-package`: runs the VIPM CLI against LabVIEW 2026 to produce
  the distributable VIP. The built artifacts are uploaded via
  `actions/upload-artifact`.
- `disable-dev-mode`: returns each LabVIEW installation to its original
  state, even if earlier steps failed.

Inspect the workflow artifacts (`vi-package` and `vipm-build-logs`) to
review the generated VIPs and the associated metadata.

## Validation tips

- Use `tools/icon-editor/Invoke-ValidateLocal.ps1` when you need a
  full-package smoke test locally. The script now operates on the
  generated VIP rather than a committed fixture.
- The `Prepare-FixtureViDiffs.ps1` and
  `Describe-IconEditorFixture.ps1` helpers accept an explicit `-FixturePath`
  so you can point them at any VIP generated by the build pipeline or a
  downloaded artifact.

## LabVIEW host prep for MissingInProject

- Use `pwsh -File tools/icon-editor/Prepare-LabVIEWHost.ps1` to stage the
  latest fixture VIP, enable icon-editor dev mode for the requested
  LabVIEW versions/bitness, close LabVIEW so the dev-mode token loads,
  and reset the workspace before running the MissingInProject suite.
  Example:

  ```powershell
  pwsh -File tools/icon-editor/Prepare-LabVIEWHost.ps1 `
    -FixturePath C:\builds\ni_icon_editor-1.4.1.948.vip `
    -Versions 2021 `
    -Bitness 32,64 `
    -StageName host-prep
  ```

- Each run writes a telemetry record under
  `tests/results/_agent/icon-editor/host-prep/` describing the inputs,
  executed steps, and any forced LabVIEW shutdowns. Attach that JSON to
  issue updates when diagnosing host-prep problems.
- The helper waits for LabVIEW to close after every stage (or forces a
  shutdown via `tools/Close-LabVIEW.ps1` â†’ `Stop-Process` if needed)
  before moving on, so rerunning it is safe and idempotent.
- The helper runs rogue-LabVIEW detection before and after the prep
  steps, sets the `LV_*` safety toggles, and writes its summary to the
  console. Pass `-DryRun` to exercise the staging pipeline without
  enabling dev mode or closing LabVIEW.
- VS Code exposes the same workflow via the
  **IconEditor: Prepare LabVIEW Host** task (Ctrl+Shift+B). Supply the
  fixture path, versions, bitness, and stage name when prompted and the
  task will queue the helper with those values.

## Housekeeping

- The repository deliberately keeps `tests/fixtures/icon-editor/`
  empty. Do not add built VIPs or manifests back into source control;
  rely on workflow artifacts instead.
- Documentation that previously referenced the committed fixture has
  been updated to this page. If you find outdated references to
  `tests/fixtures/icon-editor`, replace them with guidance that points
  to the on-demand build flow.
