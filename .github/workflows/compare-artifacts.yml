name: Compare VI artifact publish

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 45
    env:
      LV_BASE_VI: ${{ vars.LV_BASE_VI }}
      LV_HEAD_VI: ${{ vars.LV_HEAD_VI }}
      LVCOMPARE_PATH: ${{ vars.LVCOMPARE_PATH }}
      UNBLOCK_GUARD: '1'
    steps:
      - uses: actions/checkout@v5

      - name: Preflight
        shell: pwsh
        run: |
          $cli = 'C:\\Program Files\\National Instruments\\Shared\\LabVIEW Compare\\LVCompare.exe'
          if (-not (Test-Path -LiteralPath $cli)) {
            Write-Host "::error::LVCompare.exe not found at canonical path: $cli"; exit 1
          }
          $lv = Get-Process -Name 'LabVIEW' -ErrorAction SilentlyContinue
          if ($lv) { Write-Host "::error::LabVIEW.exe is running (PID(s): $($lv.Id -join ','))"; exit 1 }
          Write-Host 'Preflight OK: LVCompare present; LabVIEW not running.'

      - name: Resolve VI inputs (fallback to repo root files)
        id: res
        shell: pwsh
        run: |
          $base = $env:LV_BASE_VI
          $head = $env:LV_HEAD_VI
          
          # Fallback to repo root VI1.vi and VI2.vi for publish validation
          if ([string]::IsNullOrWhiteSpace($base) -or -not (Test-Path -LiteralPath $base)) {
            $base = Join-Path $env:GITHUB_WORKSPACE 'VI1.vi'
            Write-Host "Using fallback VI1.vi from repo root: $base"
          }
          if ([string]::IsNullOrWhiteSpace($head) -or -not (Test-Path -LiteralPath $head)) {
            $head = Join-Path $env:GITHUB_WORKSPACE 'VI2.vi'
            Write-Host "Using fallback VI2.vi from repo root: $head"
          }
          
          # Validate files exist
          if (-not (Test-Path -LiteralPath $base)) {
            Write-Host "::error::Base VI file not found: $base"
            exit 1
          }
          if (-not (Test-Path -LiteralPath $head)) {
            Write-Host "::error::Head VI file not found: $head"
            exit 1
          }
          
          Write-Host "Base VI: $base"
          Write-Host "Head VI: $head"
          "base=$base" >> $env:GITHUB_OUTPUT
          "head=$head" >> $env:GITHUB_OUTPUT

      - name: Run compare
        id: compare
        uses: ./
        with:
          base: ${{ steps.res.outputs.base }}
          head: ${{ steps.res.outputs.head }}
          fail-on-diff: 'false'

      - name: Generate HTML report
        id: report
        if: steps.compare.outcome == 'success'
        shell: pwsh
        run: |
          $outDir = Join-Path $env:RUNNER_TEMP 'compare-artifacts'
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $renderer = Join-Path $env:GITHUB_WORKSPACE 'scripts' 'Render-CompareReport.ps1'
          $dur = '${{ steps.compare.outputs.compareDurationSeconds }}'
          if (-not [string]::IsNullOrWhiteSpace($dur)) { $dur = [double]$dur } else { $dur = 0 }
          $reportPath = Join-Path $outDir 'compare-report.html'
          & $renderer `
            -Command '${{ steps.compare.outputs.command }}' `
            -ExitCode ${{ steps.compare.outputs.exitCode }} `
            -Diff '${{ steps.compare.outputs.diff }}' `
            -CliPath '${{ steps.compare.outputs.cliPath }}' `
            -DurationSeconds $dur `
            -OutputPath $reportPath
          Write-Host "HTML report generated at: $reportPath"
          "reportPath=$reportPath" >> $env:GITHUB_OUTPUT

      - name: Upload compare artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compare-vi-artifacts
          path: |
            ${{ steps.compare.outputs.compareSummaryPath }}
            ${{ steps.report.outputs.reportPath }}
          if-no-files-found: warn

      - name: Append timing to job summary
        if: steps.compare.outcome == 'success'
        shell: pwsh
        run: |
          $ns = '${{ steps.compare.outputs.compareDurationNanoseconds }}'
          $sec = '${{ steps.compare.outputs.compareDurationSeconds }}'
          $ms = ''
          if ($sec) { $ms = [math]::Round([double]$sec * 1000,2) }
          $combined = if ($sec) { "${sec}s (${ms} ms)" } else { 'n/a' }
          $line = "### Compare VI Timing`n- Seconds: $sec`n- Nanoseconds: $ns`n- Combined: $combined" 
          $line | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

      - name: Echo outputs
        if: steps.compare.outcome == 'success'
        shell: pwsh
        run: |
          Write-Host "diff=${{ steps.compare.outputs.diff }}"
          Write-Host "exitCode=${{ steps.compare.outputs.exitCode }}"
          Write-Host "compareDurationSeconds=${{ steps.compare.outputs.compareDurationSeconds }}"
          Write-Host "compareDurationNanoseconds=${{ steps.compare.outputs.compareDurationNanoseconds }}"

      - name: Runner Unblock Guard (process/jobs snapshot)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $snap = [ordered]@{}
          try {
            $procs = @(Get-Process -ErrorAction SilentlyContinue | Where-Object { $_.ProcessName -in @('conhost','pwsh','LabVIEW','LVCompare') } | Select-Object ProcessName,Id,StartTime)
            $jobs  = @(Get-Job -ErrorAction SilentlyContinue | Select-Object Id,Name,State,HasMoreData)
            $snap.processes = $procs
            $snap.jobs = $jobs
            $outDir = Get-Location
            $path = Join-Path $outDir 'runner-unblock-snapshot.json'
            $snap | ConvertTo-Json -Depth 5 | Out-File -FilePath $path -Encoding utf8

            $cleanupNote = ''
            if ($env:UNBLOCK_GUARD -eq '1') {
              $stoppedLV = 0; $stoppedLVC = 0; $stoppedJobs = 0
              try { Get-Process -Name 'LabVIEW' -ErrorAction SilentlyContinue | ForEach-Object { try { Stop-Process -Id $_.Id -ErrorAction SilentlyContinue; $stoppedLV++ } catch {} } } catch {}
              try { Get-Process -Name 'LVCompare' -ErrorAction SilentlyContinue | ForEach-Object { try { Stop-Process -Id $_.Id -ErrorAction SilentlyContinue; $stoppedLVC++ } catch {} } } catch {}
              try { $gj = @(Get-Job -ErrorAction SilentlyContinue); foreach ($j in $gj) { try { Stop-Job -Job $j -ErrorAction SilentlyContinue; Remove-Job -Job $j -Force -ErrorAction SilentlyContinue; $stoppedJobs++ } catch {} } } catch {}
              $cleanupNote = ('Cleanup: LabVIEW={0}, LVCompare={1}, Jobs={2}' -f $stoppedLV,$stoppedLVC,$stoppedJobs)
            }
            $lines = @('### Runner Unblock Guard','')
            $lines += ('- Process count: {0}' -f $procs.Count)
            $lines += ('- Pester job count: {0}' -f $jobs.Count)
            $lines += ''
            $lines += ('Snapshot: {0}' -f $path)
            if ($cleanupNote) { $lines += ('- ' + $cleanupNote) }
            $lines -join "`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          } catch { Write-Host "::warning::Unblock guard failed: $_" }
